name: Mastodon Vault Sync

on:
  # å…è®¸æ‚¨ä» Actions æ ‡ç­¾é¡µæ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      force_full_sync:
        description: 'Force a full re-sync of all posts'
        required: false
        type: boolean
        default: false
        
  # æŒ‰è®¡åˆ’è¿è¡Œï¼ˆæ¯å°æ—¶ä¸€æ¬¡ï¼‰
  schedule:
    - cron: '0 * * * *'

jobs:
  sync-and-deploy:
    name: Sync Mastodon and Deploy Archive
    runs-on: ubuntu-latest
    
    # ä¸¤ç§æ¨¡å¼éƒ½éœ€è¦å†™å…¥æƒé™
    permissions:
      contents: write
    
    steps:
      # =====================================================
      # æ­¥éª¤ 1ï¼šæ£€å‡ºã€å®‰è£…å’Œè¿è¡ŒåŒæ­¥è„šæœ¬ï¼ˆæ‰€æœ‰æ¨¡å¼é€šç”¨ï¼‰
      # =====================================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Mastodon Sync Script
        env:
          GITHUB_ACTIONS: "true"
          MASTODON_INSTANCE_URL: ${{ secrets.MASTODON_INSTANCE_URL }}
          MASTODON_USER_ID: ${{ secrets.MASTODON_USER_ID }}
          MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
          ARCHIVE_FILENAME: ${{ secrets.ARCHIVE_FILENAME }}
          # ä½¿ç”¨å›ºå®šçš„æ–‡ä»¶å¤¹åç§°ï¼Œç¡®ä¿æ‰€æœ‰å¸–å­å’Œåª’ä½“æ–‡ä»¶åˆ†åˆ«å­˜æ”¾åœ¨ mastodon å’Œ media æ–‡ä»¶å¤¹ä¸‹
          POSTS_FOLDER: mastodon
          MEDIA_FOLDER: media
          FORCE_FULL_SYNC: ${{ github.event.inputs.force_full_sync == 'true' }}
          # ä¸­å›½æ—¶åŒºè®¾ç½®ï¼štrue ä½¿ç”¨ GMT+8ï¼Œfalse ä½¿ç”¨ UTC
          CHINA_TIMEZONE: ${{ secrets.CHINA_TIMEZONE || 'false' }}
        run: python main.py

      - name: Set Environment Variables from Secrets
        run: |
          echo "ENABLE_PUSH_TO_DATA_REPO=${{ secrets.ENABLE_PUSH_TO_DATA_REPO }}" >> $GITHUB_ENV
          echo "TARGET_REPO_PAT=${{ secrets.TARGET_REPO_PAT }}" >> $GITHUB_ENV
          echo "TARGET_REPO_USERNAME=${{ secrets.TARGET_REPO_USERNAME }}" >> $GITHUB_ENV
          echo "TARGET_REPO_NAME=${{ secrets.TARGET_REPO_NAME }}" >> $GITHUB_ENV
          # è®¾ç½®å›ºå®šçš„æ–‡ä»¶å¤¹åç§°ï¼Œç¡®ä¿æ‰€æœ‰å¸–å­å’Œåª’ä½“æ–‡ä»¶åˆ†åˆ«å­˜æ”¾åœ¨ mastodon å’Œ media æ–‡ä»¶å¤¹ä¸‹
          echo "POSTS_FOLDER=mastodon" >> $GITHUB_ENV
          echo "MEDIA_FOLDER=media" >> $GITHUB_ENV
          echo "ARCHIVE_FILENAME=${{ secrets.ARCHIVE_FILENAME || 'archive.md' }}" >> $GITHUB_ENV

      # ===================================================================
      # æ­¥éª¤ 2-A (é»˜è®¤æ¨¡å¼): æäº¤å¹¶æ¨é€åˆ°å½“å‰ä»“åº“
      # ä»…å½“ "å¼€å…³" æœªè®¾ç½®ä¸º 'true' æ—¶è¿è¡Œ
      # ===================================================================
      - name: Commit and Push to Current Repository (Default)
        if: ${{ env.ENABLE_PUSH_TO_DATA_REPO != 'true' }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ç¡®ä¿æ–‡ä»¶å¤¹ç»“æ„å­˜åœ¨
          mkdir -p mastodon media
          
          if [[ -z $(git status --porcelain) ]]; then
            echo "No changes detected. Nothing to commit."
            exit 0
          fi
          
          echo "Changes detected. Committing and pushing to the current repository..."
          git add -A
          git commit -m "Automated Sync: Update Mastodon archive" -m "Last updated on $(date -u)"
          git push

      # ===================================================================
      # æ­¥éª¤ 2-B (å¯é€‰æ¨¡å¼): æ¨é€åˆ°ç‹¬ç«‹çš„è¿œç¨‹æ•°æ®ä»“åº“
      # ä»…å½“ "å¼€å…³" è®¾ç½®ä¸º 'true' ä¸”æ‰€æœ‰å¿…éœ€çš„ Secret éƒ½å­˜åœ¨æ—¶è¿è¡Œ
      # ===================================================================
      - name: Push to a Separate Data Repository (Optional)
        if: ${{ env.ENABLE_PUSH_TO_DATA_REPO == 'true' && env.TARGET_REPO_PAT && env.TARGET_REPO_USERNAME && env.TARGET_REPO_NAME }}
        run: |
          echo "Pushing backup files to data repository: ${{ env.TARGET_REPO_USERNAME }}/${{ env.TARGET_REPO_NAME }}"
          
          # å…‹éš†æ•°æ®ä»“åº“
          git clone https://x-access-token:${{ env.TARGET_REPO_PAT }}@github.com/${{ env.TARGET_REPO_USERNAME }}/${{ env.TARGET_REPO_NAME }}.git data_repo
          
          # å®šä¹‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹å˜é‡
          POSTS_DIR=mastodon
          MEDIA_DIR=media
          ARCHIVE_FILE=${{ env.ARCHIVE_FILENAME || 'archive.md' }}

          # ç¡®ä¿ç›®æ ‡ä»“åº“ä¸­å­˜åœ¨æ­£ç¡®çš„æ–‡ä»¶å¤¹ç»“æ„
          cd data_repo
          mkdir -p "$POSTS_DIR" "$MEDIA_DIR"
          
          # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œç¡®ä¿å®Œå…¨åŒæ­¥
          rm -rf "$POSTS_DIR" "$MEDIA_DIR" "$ARCHIVE_FILE" "README.md" heatmap-*.svg "index.html"

          # é¦–å…ˆå°†æ–‡ä»¶å¤åˆ¶åˆ°ä¸´æ—¶ä½ç½®
          cp -r "../$POSTS_DIR" ./
          cp -r "../$MEDIA_DIR" ./
          cp "../$ARCHIVE_FILE" ./
          cp "../README.md" ./
          cp ../heatmap-*.svg ./ 2>/dev/null || true
          cp "../index.html" ./
          
          # ç¡®ä¿æ–‡ä»¶åœ¨æ­£ç¡®çš„ä½ç½®ï¼Œæ²¡æœ‰é”™è¯¯åœ°ç§»åŠ¨åˆ°æ ¹ç›®å½•
          echo "File structure check completed"
          
          git config user.name "Mastodon Sync Action"
          git config user.email "action@github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "âœ… Data has no changes, no push needed."
          else
            echo "ğŸš€ Data updated, committing and pushing..."
            git commit -m "Automated Mastodon backup"
            git push
            echo "âœ… Push to data repository successful!"
          fi
